<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="ICN DAG Crate"><title>icn_dag - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-1a91846b.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="icn_dag" data-themes="" data-resource-suffix="" data-rustdoc-version="1.88.0 (6b00bc388 2025-06-23)" data-channel="1.88.0" data-search-js="search-f7877310.js" data-settings-js="settings-5514c975.js" ><script src="../static.files/storage-4e99c027.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-7ef8a74a.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-893ab5e7.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../icn_dag/index.html">icn_dag</a><span class="version">0.2.0</span></h2></div><div class="sidebar-elems"><ul class="block"><li><a id="all-types" href="all.html">All Items</a></li></ul><section id="rustdoc-toc"><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#icn-dag-crate" title="ICN DAG Crate">ICN DAG Crate</a><ul><li><a href="#purpose" title="Purpose">Purpose</a></li><li><a href="#pinning-and-ttl" title="Pinning and TTL">Pinning and TTL</a></li><li><a href="#synchronization-root" title="Synchronization Root">Synchronization Root</a></li><li><a href="#public-api-style" title="Public API Style">Public API Style</a></li><li><a href="#async-feature" title="Async Feature">Async Feature</a></li><li><a href="#file-storage-layout" title="File Storage Layout">File Storage Layout</a></li><li><a href="#running-persistence-tests" title="Running Persistence Tests">Running Persistence Tests</a></li><li><a href="#dag-fork-conflict-resolution" title="DAG Fork Conflict Resolution">DAG Fork Conflict Resolution</a></li><li><a href="#mutual-aid-resource-registry" title="Mutual Aid Resource Registry">Mutual Aid Resource Registry</a></li><li><a href="#contributing" title="Contributing">Contributing</a></li><li><a href="#license" title="License">License</a></li></ul></li><li><a href="#icn-dag-crate-1" title="ICN DAG Crate">ICN DAG Crate</a></li></ul><h3><a href="#modules">Crate Items</a></h3><ul class="block"><li><a href="#modules" title="Modules">Modules</a></li><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#traits" title="Traits">Traits</a></li><li><a href="#functions" title="Functions">Functions</a></li></ul></section><div id="rustdoc-modnav"></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Crate <span>icn_dag</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../src/icn_dag/lib.rs.html#1-1572">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="icn-dag-crate"><a class="doc-anchor" href="#icn-dag-crate">§</a>ICN DAG Crate</h2>
<p>This crate implements or defines interfaces for content-addressed Directed Acyclic Graph (DAG) storage and manipulation, crucial for the InterCooperative Network (ICN) data model.</p>
<p>See <a href="../../CONTEXT.md">CONTEXT.md</a> for ICN Core design philosophy and crate roles.
See <a href="../../docs/ASYNC_OVERVIEW.md">docs/ASYNC_OVERVIEW.md</a> for async API guidelines.</p>
<h3 id="purpose"><a class="doc-anchor" href="#purpose">§</a>Purpose</h3>
<p>The <code>icn-dag</code> crate is responsible for:</p>
<ul>
<li><strong>DAG Primitives:</strong> Defining core DAG structures (nodes, links, blocks) and operations (put, get, traverse).</li>
<li><strong>Content Addressing:</strong> Ensuring data integrity and retrievability using cryptographic hashes (e.g., CIDs - Content Identifiers).</li>
<li><strong>Storage Abstraction:</strong> Potentially providing interfaces for various backing stores (e.g., in-memory, disk-based, distributed).</li>
<li><strong>Serialization Formats:</strong> Defining how DAGs are serialized and deserialized (e.g., CBOR, IPLD codecs).</li>
</ul>
<p>This forms a foundational layer for data representation and exchange within the ICN.</p>
<h3 id="pinning-and-ttl"><a class="doc-anchor" href="#pinning-and-ttl">§</a>Pinning and TTL</h3>
<p>Every block stored in a DAG backend can have associated metadata indicating whether it is pinned and an optional TTL (expiration timestamp). Pinned blocks are preserved during pruning even if their TTL has passed. TTL values are expressed as seconds since the Unix epoch and may be updated after a block is stored. Implementations provide <code>pin_block</code>, <code>unpin_block</code>, and <code>prune_expired</code> to manage this metadata and remove stale content.</p>
<h3 id="synchronization-root"><a class="doc-anchor" href="#synchronization-root">§</a>Synchronization Root</h3>
<p>Whenever blocks are added or removed, file‑based stores compute a Merkle root hash from the set of top‑level CIDs and persist it in <code>dag.root</code> inside the DAG directory. This snapshot root can be read via <code>current_root()</code> to verify two nodes are synchronized.</p>
<h3 id="public-api-style"><a class="doc-anchor" href="#public-api-style">§</a>Public API Style</h3>
<p>The API style prioritizes:</p>
<ul>
<li><strong>Composability:</strong> Allowing different DAG-based data structures to be built on top.</li>
<li><strong>Performance:</strong> Efficient handling of DAG operations, especially for large graphs.</li>
<li><strong>Flexibility:</strong> Supporting different codecs and storage backends where appropriate.</li>
<li><strong>Pluggable Persistence:</strong> Includes in-memory, file-based, and optional <code>sled</code> backends via the <code>persist-sled</code> feature. When enabled, <code>SledDagStore</code> provides durable storage on disk.</li>
</ul>
<h3 id="async-feature"><a class="doc-anchor" href="#async-feature">§</a>Async Feature</h3>
<p>Enable the <code>async</code> feature to use asynchronous storage via <code>TokioFileDagStore</code>.
<code>TokioFileDagStore</code> requires your application to run on the Tokio runtime:</p>
<div class="example-wrap"><pre class="language-toml"><code>[dependencies]
icn-dag = { path = &quot;../icn-dag&quot;, features = [&quot;async&quot;] }</code></pre></div>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>icn_dag::{AsyncStorageService, TokioFileDagStore};
<span class="kw">use </span>tokio::sync::Mutex;
<span class="kw">use </span>std::path::PathBuf;

<span class="kw">let </span>store = TokioFileDagStore::new(PathBuf::from(<span class="string">"./dag"</span>)).unwrap();
<span class="kw">let </span>dag_store = Mutex::new(store); <span class="comment">// implement AsyncStorageService</span></code></pre></div>
<h3 id="file-storage-layout"><a class="doc-anchor" href="#file-storage-layout">§</a>File Storage Layout</h3>
<p>File-based stores shard blocks into subdirectories derived from the CID string.
Given a CID like <code>bafy...</code>, the block will be stored at:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code>&lt;storage&gt;/&lt;ba&gt;/&lt;fy&gt;/&lt;cid&gt;</code></pre></div>
<p>This prevents directories from growing unbounded.</p>
<h3 id="running-persistence-tests"><a class="doc-anchor" href="#running-persistence-tests">§</a>Running Persistence Tests</h3>
<p>Integration tests for each storage backend are gated by their corresponding
<code>persist-*</code> feature. Enable the feature when running <code>cargo test</code>:</p>
<div class="example-wrap"><pre class="language-bash"><code># sled backend (enabled by default)
cargo test -p icn-dag --features persist-sled --test sled_backend

# SQLite backend
cargo test -p icn-dag --no-default-features --features persist-sqlite \
  --test sqlite_backend

# RocksDB backend
cargo test -p icn-dag --no-default-features --features persist-rocksdb \
  --test rocks_backend</code></pre></div><h3 id="dag-fork-conflict-resolution"><a class="doc-anchor" href="#dag-fork-conflict-resolution">§</a>DAG Fork Conflict Resolution</h3>
<p>Federations may temporarily diverge and create competing DAG roots. Nodes apply
the following deterministic rules when reconciling forks:</p>
<ol>
<li>Prefer the root with the highest block height.</li>
<li>If heights match, choose the lexicographically smallest root CID.</li>
<li>Retain orphaned branches for audit but disallow new references.</li>
</ol>
<p>Nodes exchange <code>DagSyncStatus</code> information to detect divergence and converge on
a single history without complex reorganization.</p>
<h3 id="mutual-aid-resource-registry"><a class="doc-anchor" href="#mutual-aid-resource-registry">§</a>Mutual Aid Resource Registry</h3>
<p><code>AidResource</code> structs can be stored as DAG blocks to advertise resources
available for community sharing. Each record includes a provider DID, quantity,
description, and classification tags to support matching.</p>
<h3 id="contributing"><a class="doc-anchor" href="#contributing">§</a>Contributing</h3>
<p>Contributions are welcome! Please see the main <a href="../../CONTRIBUTING.md">CONTRIBUTING.md</a> in the root of the <code>icn-core</code> repository for guidelines.</p>
<h3 id="license"><a class="doc-anchor" href="#license">§</a>License</h3>
<p>Licensed under the Apache License, Version 2.0. See <a href="../../LICENSE">LICENSE</a>.</p>
<h2 id="icn-dag-crate-1"><a class="doc-anchor" href="#icn-dag-crate-1">§</a>ICN DAG Crate</h2>
<p>This crate implements or defines interfaces for content-addressed Directed Acyclic Graph (DAG)
storage and manipulation, crucial for the InterCooperative Network (ICN) data model.
It handles DAG primitives, content addressing, storage abstraction, and serialization formats.</p>
</div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><dl class="item-table"><dt><a class="mod" href="index/index.html" title="mod icn_dag::index">index</a></dt><dd>Helper crate for encoding/decoding root hashes</dd><dt><a class="mod" href="metrics/index.html" title="mod icn_dag::metrics">metrics</a></dt><dt><a class="mod" href="mutual_aid/index.html" title="mod icn_dag::mutual_aid">mutual_<wbr>aid</a></dt><dt><a class="mod" href="pruning/index.html" title="mod icn_dag::pruning">pruning</a></dt><dd>DAG pruning and compaction utilities</dd><dt><a class="mod" href="recognition/index.html" title="mod icn_dag::recognition">recognition</a></dt><dt><a class="mod" href="sled_store/index.html" title="mod icn_dag::sled_store">sled_<wbr>store</a></dt><dt><a class="mod" href="snapshot/index.html" title="mod icn_dag::snapshot">snapshot</a></dt><dd>DAG snapshot export/import for federation migration and testing</dd><dt><a class="mod" href="sync_monitor/index.html" title="mod icn_dag::sync_monitor">sync_<wbr>monitor</a></dt><dd>DAG synchronization monitoring and missing block detection</dd></dl><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><dl class="item-table"><dt><a class="struct" href="struct.BlockMetadata.html" title="struct icn_dag::BlockMetadata">Block<wbr>Metadata</a></dt><dd>Metadata associated with a stored DAG block.</dd><dt><a class="struct" href="struct.CompatAsyncStore.html" title="struct icn_dag::CompatAsyncStore">Compat<wbr>Async<wbr>Store</a></dt><dd>Wrapper to adapt synchronous <a href="trait.StorageService.html" title="trait icn_dag::StorageService"><code>StorageService</code></a> implementations to the async interface.</dd><dt><a class="struct" href="struct.DagBlockMetadata.html" title="struct icn_dag::DagBlockMetadata">DagBlock<wbr>Metadata</a></dt><dd>Basic metadata describing a <a href="../icn_common/struct.DagBlock.html" title="struct icn_common::DagBlock"><code>DagBlock</code></a>.</dd><dt><a class="struct" href="struct.FileDagStore.html" title="struct icn_dag::FileDagStore">File<wbr>DagStore</a></dt><dd>Simple file-based <a href="trait.StorageService.html" title="trait icn_dag::StorageService"><code>StorageService</code></a> storing one JSON file per block.</dd><dt><a class="struct" href="struct.InMemoryDagStore.html" title="struct icn_dag::InMemoryDagStore">InMemory<wbr>DagStore</a></dt><dd>Simple in-memory implementation of <a href="trait.StorageService.html" title="trait icn_dag::StorageService"><code>StorageService</code></a> for tests and examples.</dd><dt><a class="struct" href="struct.TokioFileDagStore.html" title="struct icn_dag::TokioFileDagStore">Tokio<wbr>File<wbr>DagStore</a></dt><dd>Asynchronous file-based <a href="trait.AsyncStorageService.html" title="trait icn_dag::AsyncStorageService"><code>AsyncStorageService</code></a> using <code>tokio::fs</code> for I/O.</dd></dl><h2 id="traits" class="section-header">Traits<a href="#traits" class="anchor">§</a></h2><dl class="item-table"><dt><a class="trait" href="trait.AsyncStorageService.html" title="trait icn_dag::AsyncStorageService">Async<wbr>Storage<wbr>Service</a></dt><dd>Asynchronous version of <a href="trait.StorageService.html" title="trait icn_dag::StorageService"><code>StorageService</code></a>.</dd><dt><a class="trait" href="trait.StorageService.html" title="trait icn_dag::StorageService">Storage<wbr>Service</a></dt><dd>Defines the interface for a DAG block storage backend.
Generic over the block type <code>B</code> which must implement <code>Clone</code> and be serializable/deserializable.</dd></dl><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2><dl class="item-table"><dt><a class="fn" href="fn.backup.html" title="fn icn_dag::backup">backup</a></dt><dd>Backup all DAG blocks from <code>store</code> into files under <code>path</code>.</dd><dt><a class="fn" href="fn.backup_async.html" title="fn icn_dag::backup_async">backup_<wbr>async</a></dt><dd>Asynchronous variant of <a href="fn.backup.html" title="fn icn_dag::backup"><code>backup</code></a>.</dd><dt><a class="fn" href="fn.choose_canonical_root.html" title="fn icn_dag::choose_canonical_root">choose_<wbr>canonical_<wbr>root</a></dt><dd>Choose canonical root from <code>(Cid, height)</code> candidates.</dd><dt><a class="fn" href="fn.compute_dag_root.html" title="fn icn_dag::compute_dag_root">compute_<wbr>dag_<wbr>root</a></dt><dd>Compute a Merkle root hash from a set of top-level CIDs.</dd><dt><a class="fn" href="fn.current_root.html" title="fn icn_dag::current_root">current_<wbr>root</a></dt><dd>Determine the current root CID of the DAG.</dd><dt><a class="fn" href="fn.metadata_from_block.html" title="fn icn_dag::metadata_from_block">metadata_<wbr>from_<wbr>block</a></dt><dd>Create <a href="struct.DagBlockMetadata.html" title="struct icn_dag::DagBlockMetadata"><code>DagBlockMetadata</code></a> from a <a href="../icn_common/struct.DagBlock.html" title="struct icn_common::DagBlock"><code>DagBlock</code></a>.</dd><dt><a class="fn" href="fn.process_dag_related_data.html" title="fn icn_dag::process_dag_related_data">process_<wbr>dag_<wbr>related_<wbr>data</a></dt><dd>Placeholder function demonstrating use of common types.</dd><dt><a class="fn" href="fn.restore.html" title="fn icn_dag::restore">restore</a></dt><dd>Restore DAG blocks into <code>store</code> from files under <code>path</code>.</dd><dt><a class="fn" href="fn.restore_async.html" title="fn icn_dag::restore_async">restore_<wbr>async</a></dt><dd>Asynchronous variant of <a href="fn.restore.html" title="fn icn_dag::restore"><code>restore</code></a>.</dd><dt><a class="fn" href="fn.verify_all.html" title="fn icn_dag::verify_all">verify_<wbr>all</a></dt><dd>Verify integrity of every block in the given store.</dd><dt><a class="fn" href="fn.verify_all_async.html" title="fn icn_dag::verify_all_async">verify_<wbr>all_<wbr>async</a></dt><dd>Asynchronous variant of <a href="fn.verify_all.html" title="fn icn_dag::verify_all"><code>verify_all</code></a>.</dd></dl></section></div></main></body></html>